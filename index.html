<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Weight Tracker</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  background: #f5f2ee;
  color: #1a1614;
  min-height: 100vh;
}

.header {
  background: #2c2420;
  padding: 18px 20px;
  padding-top: calc(18px + env(safe-area-inset-top));
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-sub {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  color: #c8b89a;
  text-transform: uppercase;
  margin-bottom: 3px;
}
.header-title {
  font-size: 22px;
  font-weight: 700;
  color: #ffffff;
  letter-spacing: -0.4px;
}
.settings-btn {
  background: rgba(255,255,255,0.12);
  border: 1.5px solid rgba(255,255,255,0.25);
  color: #ffffff;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer;
}

.main {
  padding: 14px 16px;
  max-width: 520px;
  margin: 0 auto;
}

.card {
  background: #ffffff;
  border-radius: 14px;
  padding: 22px 20px;
  margin-bottom: 10px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
}
.card-label {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1.5px;
  color: #6b5d57;
  text-transform: uppercase;
  margin-bottom: 14px;
}

/* PROJECTION CARD */
.projection-card { text-align: center; }
.projection-number {
  font-size: 68px;
  font-weight: 800;
  line-height: 1;
  letter-spacing: -3px;
  margin-bottom: 4px;
  color: #6b5d57;
}
.projection-unit {
  font-size: 18px;
  color: #6b5d57;
  font-weight: 500;
  margin-bottom: 18px;
}
.stats-row {
  display: flex;
  border-top: 1px solid #d4c8be;
  padding-top: 16px;
  gap: 4px;
}
.stat { text-align: center; flex: 1; }
.stat-value {
  font-size: 22px;
  font-weight: 800;
  color: #1a1614;
  letter-spacing: -0.5px;
}
.stat-label {
  font-size: 12px;
  color: #6b5d57;
  margin-top: 3px;
  font-weight: 600;
}
.status-badge {
  margin-top: 14px;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  line-height: 1.4;
}
.empty-msg { color: #6b5d57; font-size: 15px; }

/* WEIGH-IN CARD */
.weighin-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 14px;
}
.weighin-stats { display: flex; gap: 24px; }
.weighin-stat-value {
  font-size: 26px;
  font-weight: 800;
  color: #1a1614;
  letter-spacing: -0.5px;
  line-height: 1;
  margin-bottom: 3px;
}
.weighin-stat-label { font-size: 12px; font-weight: 600; color: #6b5d57; }
.weighin-stat-sub { font-size: 12px; color: #6b5d57; margin-top: 2px; }
.log-weight-row { display: flex; flex-direction: column; gap: 0; border-top: 1px solid #d4c8be; padding-top: 14px; }
.log-weight-inputs { display: flex; gap: 10px; align-items: flex-start; }
.log-weight-inputs .field { flex: 1; min-width: 0; }

/* CALORIE TARGET CARD */
.target-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #f0ebe6;
}
.target-row:last-child { border-bottom: none; padding-bottom: 0; }
.target-row:first-child { padding-top: 0; }
.target-label { font-size: 15px; color: #3d3330; font-weight: 500; }
.target-value { font-size: 17px; font-weight: 800; color: #1a1614; }
.target-value.highlight { color: #1e5c38; }

/* LOG FORM */
.log-row { display: flex; flex-direction: column; gap: 0; }
.log-row-inputs { display: flex; gap: 10px; align-items: flex-start; }
.field { display: flex; flex-direction: column; }
.field-cals { flex: 1; min-width: 0; }

label {
  font-size: 13px;
  font-weight: 600;
  color: #6b5d57;
  margin-bottom: 6px;
  display: block;
}
input[type="date"],
input[type="number"],
input[type="text"] {
  padding: 0;
  border: none !important;
  border-radius: 0;
  font-size: 16px;
  background: transparent !important;
  color: #1a1614;
  outline: none;
  height: 100%;
  width: 100%;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  -webkit-appearance: none !important;
  -moz-appearance: none;
  appearance: none;
  box-shadow: none !important;
  -webkit-box-shadow: none !important;
  display: block;
  box-sizing: border-box;
}
.input-wrap {
  border: 1.5px solid #d4c8be;
  border-radius: 10px;
  background: #ffffff;
  height: 50px;
  display: flex;
  align-items: center;
  padding: 0 14px;
  width: 100%;
  box-sizing: border-box;
}
.input-wrap input {
  flex: 1;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  -webkit-box-shadow: none !important;
  background: transparent !important;
  -webkit-appearance: none !important;
  appearance: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
  font-size: 16px !important;
  color: #1a1614 !important;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif !important;
  height: auto !important;
  width: 100% !important;
}
input[type="date"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 2;
}
.date-nav {
  display: flex;
  align-items: center;
  height: 50px;
  border: 1.5px solid #d4c8be;
  border-radius: 10px;
  background: #ffffff;
  overflow: hidden;
  width: 100%;
  margin-bottom: 10px;
}
.date-nav-arrow {
  width: 40px;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  font-size: 18px;
  color: #6b5d57;
  cursor: pointer;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  flex-shrink: 0;
  -webkit-appearance: none;
  padding: 0;
  tap-highlight-color: transparent;
}
.date-nav-arrow:active { background: #f5f2ee; }
.date-nav-label {
  flex: 1;
  text-align: center;
  font-size: 15px;
  color: #1a1614;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  font-weight: 500;
  white-space: nowrap;
  padding: 0 2px;
  border-left: 1px solid #e8e0d8;
  border-right: 1px solid #e8e0d8;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }
input::placeholder { color: #b0a099; }

.add-btn-wrap { flex: 0 0 auto; padding-top: 25px; }
.add-btn {
  background: #2c2420;
  color: #ffffff;
  border: none;
  padding: 0 16px;
  font-size: 15px;
  font-weight: 700;
  border-radius: 10px;
  -webkit-border-radius: 10px;
  height: 50px;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer;
  white-space: nowrap;
  -webkit-appearance: none;
}
.add-btn-bottom {
  background: #2c2420;
  color: #ffffff;
  border: none;
  padding: 0 16px;
  font-size: 15px;
  font-weight: 700;
  border-radius: 10px;
  -webkit-border-radius: 10px;
  height: 50px;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer;
  white-space: nowrap;
  flex: 0 0 auto;
  -webkit-appearance: none;
}

/* HISTORY */
.history-scroll {
  max-height: 280px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.history-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #d4c8be;
}
.history-date { font-size: 16px; font-weight: 600; color: #3d3330; }
.history-right { display: flex; align-items: center; gap: 8px; }
.history-cals { font-size: 16px; font-weight: 700; color: #1a1614; }
.deficit-badge { font-size: 13px; font-weight: 600; padding: 3px 7px; border-radius: 5px; }
.delete-btn {
  background: none;
  border: none;
  color: #6b5d57;
  font-size: 22px;
  padding: 0 4px;
  line-height: 1;
  cursor: pointer;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
}

/* SETTINGS SHEET */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 100;
}
.overlay.open { display: flex; }
.sheet {
  background: #f5f2ee;
  border-radius: 18px 18px 0 0;
  padding: 28px 20px 40px;
  padding-bottom: calc(40px + env(safe-area-inset-bottom));
  width: 100%;
  max-width: 520px;
  box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
  max-height: 90vh;
  overflow-y: auto;
}
.sheet-title { font-size: 20px; font-weight: 700; color: #1a1614; margin-bottom: 22px; }
.sheet-section {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  color: #6b5d57;
  text-transform: uppercase;
  margin-bottom: 12px;
  margin-top: 22px;
}
.sheet-section:first-of-type { margin-top: 0; }
.setting-field { margin-bottom: 16px; }
.setting-field input { width: 100%; }
.hint { font-size: 14px; color: #6b5d57; margin-top: -8px; margin-bottom: 16px; line-height: 1.5; }
.toggle-row { display: flex; gap: 8px; margin-bottom: 8px; }
.toggle-btn {
  flex: 1; padding: 11px 8px; border: 1.5px solid #d4c8be;
  border-radius: 10px; background: #ffffff; color: #6b5d57;
  font-size: 15px; font-weight: 600; font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer; -webkit-appearance: none;
}
.toggle-btn-active {
  background: #2c2420; color: #ffffff; border-color: #2c2420;
}

.sheet-divider { height: 1px; background: #d4c8be; margin: 20px 0; }

.calorie-target-preview {
  background: #ffffff;
  border-radius: 10px;
  padding: 14px 16px;
  margin-bottom: 20px;
}
.ctp-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
.ctp-label { font-size: 14px; color: #3d3330; }
.ctp-value { font-size: 15px; font-weight: 700; color: #1a1614; }
.ctp-value.green { color: #1e5c38; }

.sheet-buttons { display: flex; gap: 12px; }
.cancel-btn {
  flex: 1;
  background: none;
  border: 1.5px solid #d4c8be;
  color: #3d3330;
  padding: 14px;
  border-radius: 10px;
  -webkit-border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer;
  -webkit-appearance: none;
}
.save-btn {
  flex: 1;
  background: #2c2420;
  color: #ffffff;
  border: none;
  padding: 14px;
  border-radius: 10px;
  -webkit-border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
  cursor: pointer;
  -webkit-appearance: none;
}
.spacer { height: 20px; }
.milestone-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 11px 0;
  border-bottom: 1px solid #f0ebe6;
}
.milestone-row:last-child { border-bottom: none; padding-bottom: 0; }
.milestone-row:first-child { padding-top: 0; }
.milestone-label { font-size: 15px; color: #3d3330; font-weight: 500; }
.milestone-value { font-size: 17px; font-weight: 800; color: #1a1614; }
.milestone-value.at-goal { color: #1e5c38; }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="header-sub" id="headerSub">August Countdown</div>
    <div class="header-title">Weight Projection</div>
  </div>
  <button class="settings-btn" onclick="openSettings()">Settings</button>
</div>

<div class="main">

  <!-- Storage warning banner -->
  <div id="storageBanner" style="display:none;background:#fde8e8;border:1.5px solid #e8b4b4;border-radius:10px;padding:14px 16px;margin-bottom:10px;font-size:14px;color:#7a1818;line-height:1.5;">
    <strong>Data won't save between sessions.</strong> Your browser is blocking local storage — this often happens in Firefox private mode or with strict privacy settings. Try opening this page in Safari, or go to Firefox Settings &rarr; Data Management and make sure vanishstar.github.io is allowed.
  </div>

  <!-- Projection card -->
  <div class="card projection-card">
    <div class="card-label" id="projCardLabel">Projected Weight &middot; Aug 1st</div>
    <div class="projection-number" id="projNum">&#8212;</div>
    <div class="projection-unit">lbs</div>
    <div id="projStats" style="display:none">
      <div class="stats-row">
        <div class="stat"><div class="stat-value" id="avgCal">&#8212;</div><div class="stat-label">Avg cal/day</div></div>
        <div class="stat"><div class="stat-value" id="avgDef">&#8212;</div><div class="stat-label">Daily deficit</div></div>
        <div class="stat"><div class="stat-value" id="daysLeft">&#8212;</div><div class="stat-label">Days left</div></div>
      </div>
      <div class="status-badge" id="statusBadge"></div>
    </div>
    <div class="empty-msg" id="emptyMsg">Log your first day below to see your projection.</div>
  </div>

  <!-- Calorie target card -->
  <div class="card" id="targetCard">
    <div class="card-label">To reach your goal</div>
    <div class="target-row">
      <span class="target-label">Goal weight</span>
      <span class="target-value" id="t_goal">&#8212;</span>
    </div>
    <div class="target-row">
      <span class="target-label">Lbs to lose</span>
      <span class="target-value" id="t_tolose">&#8212;</span>
    </div>
    <div class="target-row">
      <span class="target-label">Required daily deficit</span>
      <span class="target-value" id="t_deficit">&#8212;</span>
    </div>
    <div class="target-row">
      <span class="target-label">Daily calorie target</span>
      <span class="target-value highlight" id="t_caltarget">&#8212;</span>
    </div>
  </div>

  <!-- Weigh-in card -->
  <div class="card">
    <div class="card-label">Weight Log</div>
    <div class="weighin-top">
      <div class="weighin-stats">
        <div>
          <div class="weighin-stat-value" id="wi_current">&#8212;</div>
          <div class="weighin-stat-label">Current weight</div>
          <div class="weighin-stat-sub" id="wi_date"></div>
        </div>
        <div>
          <div class="weighin-stat-value" id="wi_lost" style="color:#1e5c38">&#8212;</div>
          <div class="weighin-stat-label">Total lost</div>
          <div class="weighin-stat-sub" id="wi_start"></div>
        </div>
      </div>
    </div>
    <div class="log-weight-row">
      <div>
        <label>Date</label>
        <div class="date-nav">
          <button class="date-nav-arrow" onclick="shiftDate('wiDate',-1)">&#8249;</button>
          <div class="date-nav-label" id="wiDateLabel">Today</div>
          <button class="date-nav-arrow" onclick="shiftDate('wiDate',1)">&#8250;</button>
        </div>
      </div>
      <div class="log-weight-inputs">
        <div class="field" style="flex:1;min-width:0">
          <label for="wi_weightInput">Weight (lbs)</label>
          <div class="input-wrap"><input type="number" id="wi_weightInput" placeholder="e.g. 165.2" step="0.1"></div>
        </div>
        <button class="add-btn-bottom" style="margin-top:23px" onclick="addWeighIn()">Log</button>
      </div>
    </div>
  </div>

  <!-- Calorie log form -->
  <div class="card">
    <div class="card-label">Log a Day</div>
    <div class="log-row">
      <div>
        <label>Date</label>
        <div class="date-nav">
          <button class="date-nav-arrow" onclick="shiftDate('calDate',-1)">&#8249;</button>
          <div class="date-nav-label" id="calDateLabel">Today</div>
          <button class="date-nav-arrow" onclick="shiftDate('calDate',1)">&#8250;</button>
        </div>
      </div>
      <div class="log-row-inputs">
        <div class="field field-cals">
          <label for="calInput">Calories</label>
          <div class="input-wrap"><input type="number" id="calInput" placeholder="e.g. 1200"></div>
        </div>
        <div class="add-btn-wrap" style="padding-top:23px">
          <button class="add-btn" onclick="addEntry()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calorie history -->
  <div class="card" id="historyCard" style="display:none">
    <div class="card-label" id="historyLabel">Calorie History</div>
    <div class="history-scroll" id="historyList"></div>
  </div>

  <!-- Milestone card -->
  <div class="card" id="milestoneCard" style="display:none">
    <div class="card-label">At this pace&hellip;</div>
    <div id="milestoneList"></div>
  </div>

  <div class="spacer"></div>
</div>

<!-- Settings sheet -->
<div class="overlay" id="overlay" onclick="overlayClick(event)">
  <div class="sheet">
    <div class="sheet-title">Settings</div>

    <div class="sheet-section">Starting point</div>
    <div class="setting-field">
      <label for="s_startWeight">Starting weight (lbs)</label>
      <div class="input-wrap"><input type="number" id="s_startWeight" step="0.1"></div>
    </div>
    <div class="setting-field">
      <label>Start date</label>
      <div class="date-nav">
        <button class="date-nav-arrow" onclick="shiftSettingsDate('startDate',-1)">&#8249;</button>
        <div class="date-nav-label" id="s_startDate_display">Select date</div>
        <button class="date-nav-arrow" onclick="shiftSettingsDate('startDate',1)">&#8250;</button>
      </div>
    </div>
    <div class="setting-field">
      <label for="s_tdee">Maintenance calories (TDEE)</label>
      <div class="input-wrap"><input type="number" id="s_tdee"></div>
    </div>
    <p class="hint">This is calculated automatically from your weight — the number above is just for reference.</p>
    <div class="setting-field">
      <label>Activity level</label>
      <div class="toggle-row">
        <button id="btn_sedentary" class="toggle-btn toggle-btn-active" onclick="setActivity('sedentary')">Sedentary</button>
        <button id="btn_lightly_active" class="toggle-btn" onclick="setActivity('lightly_active')">Lightly active</button>
      </div>
      <p class="hint" style="margin-top:8px">Sedentary = desk job, minimal exercise. Lightly active = 1&ndash;3 days/week of light activity.</p>
    </div>

    <div class="sheet-divider"></div>
    <div class="sheet-section">Goal</div>
    <div class="setting-field">
      <label for="s_goalWeight">Goal weight (lbs)</label>
      <div class="input-wrap"><input type="number" id="s_goalWeight" step="0.1"></div>
    </div>
    <div class="setting-field">
      <label>Target date</label>
      <div class="date-nav">
        <button class="date-nav-arrow" onclick="shiftSettingsDate('targetDate',-1)">&#8249;</button>
        <div class="date-nav-label" id="s_targetDate_display">Select date</div>
        <button class="date-nav-arrow" onclick="shiftSettingsDate('targetDate',1)">&#8250;</button>
      </div>
    </div>

    <div class="calorie-target-preview" id="ctpPreview">
      <div class="ctp-row"><span class="ctp-label">Lbs to lose</span><span class="ctp-value" id="ctp_lose">&#8212;</span></div>
      <div class="ctp-row"><span class="ctp-label">Days until target</span><span class="ctp-value" id="ctp_days">&#8212;</span></div>
      <div class="ctp-row"><span class="ctp-label">Required daily deficit</span><span class="ctp-value" id="ctp_deficit">&#8212;</span></div>
      <div class="ctp-row"><span class="ctp-label">Daily calorie target</span><span class="ctp-value green" id="ctp_target">&#8212;</span></div>
    </div>

    <input type="hidden" id="s_startDate_hidden">
    <input type="hidden" id="s_targetDate_hidden">
    <div class="sheet-divider"></div>
    <div class="sheet-section">Backup &amp; restore</div>
    <div class="setting-field">
      <label>Calorie log data</label>
      <textarea id="importExportBox" rows="5" style="width:100%;padding:11px 14px;border:1.5px solid #d4c8be;border-radius:10px;font-size:14px;font-family:-apple-system,system-ui,sans-serif;color:#1a1614;background:#ffffff;resize:vertical;box-sizing:border-box;line-height:1.4;"></textarea>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:20px">
      <button class="toggle-btn" style="flex:1" onclick="exportData()">Export</button>
      <button class="toggle-btn" style="flex:1" onclick="importData()">Import</button>
    </div>
    <p class="hint" style="margin-top:-12px">Export copies your log to the box above — then paste it into Notes for safekeeping. To restore, paste it back in and tap Import.</p>

    <div class="sheet-buttons">
      <button class="cancel-btn" onclick="closeSettings()">Cancel</button>
      <button class="save-btn" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
var STORAGE_KEY = "wl-tracker-v2";

var state = {
  settings: {
    startWeight: 166.6,
    startDate: todayStr(),
    tdee: 1750,
    goalWeight: 145,
    targetDate: "2026-08-01",
    activityLevel: "sedentary"
  },
  log: [],
  weighIns: []
};

// Date navigation state
var calDate = new Date();
var wiDate = new Date();
var settingsStartDate = todayStr();
var settingsTargetDate = "2026-08-01";

function dateToStr(d) {
  return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
}

function strToDate(s) {
  var p = s.split("-").map(Number);
  return new Date(p[0], p[1]-1, p[2]);
}

function formatDateNice(d) {
  var today = new Date(); today.setHours(0,0,0,0);
  var yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
  d.setHours(0,0,0,0);
  if (d.getTime() === today.getTime()) return "Today";
  if (d.getTime() === yesterday.getTime()) return "Yesterday";
  var diff = Math.round((today - d) / 86400000);
  if (diff > 0 && diff <= 6) return d.toLocaleDateString("en-US", {weekday:"short", month:"short", day:"numeric"});
  return d.toLocaleDateString("en-US", {month:"short", day:"numeric"});
}

function settingsDateToDate(which) {
  var str = which === 'startDate' ? settingsStartDate : settingsTargetDate;
  return strToDate(str);
}

function shiftSettingsDate(which, delta) {
  var d = which === 'startDate' ? strToDate(settingsStartDate) : strToDate(settingsTargetDate);
  d.setDate(d.getDate() + delta);
  var str = dateToStr(d);
  var label = d.toLocaleDateString("en-US", {month:"short", day:"numeric", year:"numeric"});
  if (which === 'startDate') {
    settingsStartDate = str;
    document.getElementById("s_startDate_display").textContent = label;
    // sync hidden value for saveSettings
    document.getElementById("s_startDate_hidden").value = str;
  } else {
    settingsTargetDate = str;
    document.getElementById("s_targetDate_display").textContent = label;
    document.getElementById("s_targetDate_hidden").value = str;
  }
  updateSettingsPreview();
}

function shiftDate(which, delta) {
  if (which === 'calDate') {
    calDate.setDate(calDate.getDate() + delta);
    document.getElementById("calDateLabel").textContent = formatDateNice(new Date(calDate));
  } else {
    wiDate.setDate(wiDate.getDate() + delta);
    document.getElementById("wiDateLabel").textContent = formatDateNice(new Date(wiDate));
  }
}

function calcTDEE(weightLbs) {
  // Mifflin-St Jeor for Erin's stats: 30yo, 5'4" (162.6cm)
  var kg = weightLbs * 0.453592;
  var bmr = (10 * kg) + (6.25 * 162.6) - (5 * 30) - 161;
  var multiplier = state.settings.activityLevel === "lightly_active" ? 1.375 : 1.2;
  return Math.round(bmr * multiplier);
}

function save() {
  try {
    var data = JSON.stringify(state);
    localStorage.setItem(STORAGE_KEY, data);
    // Verify it actually wrote
    var check = localStorage.getItem(STORAGE_KEY);
    if (!check) showStorageWarning();
  } catch(e) {
    showStorageWarning();
  }
}

var storageWarningShown = false;

function showStorageWarning() {
  if (storageWarningShown) return;
  storageWarningShown = true;
  var banner = document.getElementById("storageBanner");
  if (banner) banner.style.display = "block";
}

function testStorage() {
  try {
    localStorage.setItem("__test__", "1");
    var v = localStorage.getItem("__test__");
    localStorage.removeItem("__test__");
    return v === "1";
  } catch(e) { return false; }
}

function load() {
  var raw = null;
  try { raw = localStorage.getItem(STORAGE_KEY); } catch(e) { return; }
  if (!raw) { return; }
  try {
    var parsed = JSON.parse(raw);
    if (parsed.settings) {
      state.settings = parsed.settings;
      if (!state.settings.goalWeight) state.settings.goalWeight = 145;
      if (!state.settings.targetDate) state.settings.targetDate = "2026-08-01";
      if (!state.settings.activityLevel) state.settings.activityLevel = "sedentary";
    }
    if (parsed.log) state.log = parsed.log;
    if (parsed.weighIns) state.weighIns = parsed.weighIns;
  } catch(e) {  }
}

function todayStr() {
  var t = new Date();
  return t.getFullYear() + "-" + pad(t.getMonth()+1) + "-" + pad(t.getDate());
}

function pad(n) { return String(n).padStart(2, "0"); }

function daysBetween(a, b) {
  return Math.round((b - a) / (1000*60*60*24));
}

function formatDate(dateStr) {
  var parts = dateStr.split("-").map(Number);
  return new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString("en-US", {month:"short", day:"numeric"});
}

function formatDateLong(dateStr) {
  var parts = dateStr.split("-").map(Number);
  return new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString("en-US", {month:"short", day:"numeric", year:"numeric"});
}

function calcTarget(startWeight, goalWeight, tdee, targetDate) {
  var today = new Date(); today.setHours(0,0,0,0);
  var target = new Date(targetDate + "T00:00:00");
  var days = daysBetween(today, target);
  if (days <= 0) return null;
  var toLose = startWeight - goalWeight;
  var deficitNeeded = (toLose * 3500) / days;
  var calTarget = Math.round(tdee - deficitNeeded);
  return {
    days: days,
    toLose: toLose,
    deficitNeeded: Math.round(deficitNeeded),
    calTarget: calTarget
  };
}

function render() {
  var today = new Date(); today.setHours(0,0,0,0);
  var targetDateObj = new Date(state.settings.targetDate + "T00:00:00");
  var daysToTarget = daysBetween(today, targetDateObj);
  var startDateObj = new Date(state.settings.startDate + "T00:00:00");
  var totalDays = daysBetween(startDateObj, targetDateObj);

  // Update header and projection label
  document.getElementById("headerSub").textContent = formatDateLong(state.settings.targetDate) + " Countdown";
  document.getElementById("projCardLabel").textContent = "Projected Weight \u00b7 " + formatDate(state.settings.targetDate);

  var hasLog = state.log.length > 0;
  var avgCalories = null, avgDeficit = null, projectedWeight = null;

  // Use current logged weight for TDEE, otherwise starting weight
  var currentWeightForTDEE = state.weighIns.length > 0
    ? state.weighIns[state.weighIns.length - 1].weight
    : state.settings.startWeight;
  var dynamicTDEE = calcTDEE(currentWeightForTDEE);

  if (hasLog) {
    var sum = 0;
    for (var i = 0; i < state.log.length; i++) sum += state.log[i].calories;
    avgCalories = Math.round(sum / state.log.length);
    avgDeficit = dynamicTDEE - avgCalories;
    projectedWeight = state.settings.startWeight - (avgDeficit * totalDays) / 3500;
  }

  // Projection number
  var projNum = document.getElementById("projNum");
  projNum.textContent = projectedWeight !== null ? projectedWeight.toFixed(1) : "\u2014";

  var goal = state.settings.goalWeight;
  var color = "#6b5d57", bg = "#f5f2ee";
  if (projectedWeight !== null) {
    if (projectedWeight <= goal)        { color = "#1e5c38"; bg = "#e6f4ec"; }
    else if (projectedWeight <= goal+5) { color = "#7a4800"; bg = "#fff3e0"; }
    else                                { color = "#7a1818"; bg = "#fde8e8"; }
  }
  projNum.style.color = color;

  var projStats = document.getElementById("projStats");
  var emptyMsg = document.getElementById("emptyMsg");
  if (hasLog) {
    projStats.style.display = "block";
    emptyMsg.style.display = "none";
    document.getElementById("avgCal").textContent = avgCalories.toLocaleString();
    document.getElementById("avgDef").textContent = avgDeficit > 0 ? "+" + Math.round(avgDeficit) : String(Math.round(avgDeficit));
    document.getElementById("daysLeft").textContent = daysToTarget;
    var badge = document.getElementById("statusBadge");
    badge.style.background = bg;
    badge.style.color = color;
    badge.textContent = projectedWeight <= goal
      ? "\u2713 On track for your goal of " + goal + " lbs"
      : (projectedWeight - goal).toFixed(1) + " lbs above goal";
  } else {
    projStats.style.display = "none";
    emptyMsg.style.display = "block";
  }

  // Calorie target card — uses current weight from weigh-ins if available
  var currentWeightForTarget = state.settings.startWeight;
  if (state.weighIns.length > 0) {
    currentWeightForTarget = state.weighIns[state.weighIns.length - 1].weight;
  }
  var tc = calcTarget(currentWeightForTarget, state.settings.goalWeight, calcTDEE(currentWeightForTarget), state.settings.targetDate);
  if (tc) {
    document.getElementById("t_goal").textContent = state.settings.goalWeight + " lbs";
    document.getElementById("t_tolose").textContent = tc.toLose.toFixed(1) + " lbs";
    document.getElementById("t_deficit").textContent = tc.deficitNeeded.toLocaleString() + " cal/day";
    document.getElementById("t_caltarget").textContent = tc.calTarget.toLocaleString() + " cal/day";
  }

  // Weigh-in card
  if (state.weighIns.length > 0) {
    var latest = state.weighIns[state.weighIns.length - 1];
    var lost = state.settings.startWeight - latest.weight;
    document.getElementById("wi_current").textContent = latest.weight.toFixed(1) + " lbs";
    document.getElementById("wi_date").textContent = "as of " + formatDate(latest.date);
    var lostRounded = Math.round(lost * 10) / 10;
    document.getElementById("wi_lost").textContent = (lostRounded > 0 ? "-" : lostRounded < 0 ? "+" : "") + Math.abs(lostRounded).toFixed(1) + " lbs";
    document.getElementById("wi_start").textContent = "since " + formatDate(state.settings.startDate);
  } else {
    document.getElementById("wi_current").textContent = state.settings.startWeight + " lbs";
    document.getElementById("wi_date").textContent = "starting weight";
    document.getElementById("wi_lost").textContent = "0 lbs";
    document.getElementById("wi_start").textContent = "nothing logged yet";
  }

  // Calorie history
  // Milestones
  var milestoneCard = document.getElementById("milestoneCard");
  var milestoneList = document.getElementById("milestoneList");
  if (avgDeficit !== null) {
    milestoneCard.style.display = "block";
    var months = [1, 2, 3, 4, 5, 6];
    var html = "";
    for (var m = 0; m < months.length; m++) {
      var days = Math.round(months[m] * 30.44);
      // Use projected weight at that point to get a more accurate TDEE
      var daysElapsed = daysBetween(startDateObj, today);
      var projWeight = state.settings.startWeight - (avgDeficit * daysElapsed) / 3500;
      var milestoneTDEE = calcTDEE(projWeight);
      var milestoneDeficit = milestoneTDEE - avgCalories;
      var proj = projWeight - (milestoneDeficit * days) / 3500;
      proj = Math.round(proj * 10) / 10;
      var label = months[m] === 1 ? "1 month" : months[m] + " months";
      var atGoal = proj <= state.settings.goalWeight;
      html += '<div class="milestone-row">'
        + '<span class="milestone-label">' + label + '</span>'
        + '<span class="milestone-value' + (atGoal ? ' at-goal' : '') + '">'
        + proj.toFixed(1) + ' lbs' + (atGoal ? ' ✓' : '') + '</span>'
        + '</div>';
    }
    milestoneList.innerHTML = html;
  } else {
    milestoneCard.style.display = "none";
  }

  var historyCard = document.getElementById("historyCard");
  var historyList = document.getElementById("historyList");
  if (hasLog) {
    historyCard.style.display = "block";
    document.getElementById("historyLabel").textContent = "Calorie History \u00b7 " + state.log.length + (state.log.length === 1 ? " day" : " days");
    var sorted = state.log.slice().reverse();
    var html = "";
    for (var j = 0; j < sorted.length; j++) {
      var entry = sorted[j];
      var deficit = state.settings.tdee - entry.calories;
      var isDeficit = deficit >= 0;
      var bc = isDeficit ? "#1e5c38" : "#7a1818";
      var bb = isDeficit ? "#e6f4ec" : "#fde8e8";
      var sign = isDeficit ? "\u2212" : "+";
      html += '<div class="history-row">'
        + '<span class="history-date">' + formatDate(entry.date) + '</span>'
        + '<div class="history-right">'
        + '<span class="history-cals">' + entry.calories.toLocaleString() + '</span>'
        + '<span class="deficit-badge" style="color:' + bc + ';background:' + bb + '">' + sign + Math.abs(deficit) + '</span>'
        + '<button class="delete-btn" onclick="removeEntry(\'' + entry.date + '\')">&times;</button>'
        + '</div></div>';
    }
    historyList.innerHTML = html;
  } else {
    historyCard.style.display = "none";
  }
}

function addEntry() {
  var dateVal = dateToStr(calDate);
  var calVal = document.getElementById("calInput").value;
  var cals = parseInt(calVal);
  if (!dateVal || !calVal || isNaN(cals) || cals < 0) return;
  var existing = -1;
  for (var i = 0; i < state.log.length; i++) {
    if (state.log[i].date === dateVal) { existing = i; break; }
  }
  if (existing >= 0) {
    state.log[existing] = { date: dateVal, calories: cals };
  } else {
    state.log.push({ date: dateVal, calories: cals });
    state.log.sort(function(a,b) { return a.date.localeCompare(b.date); });
  }
  document.getElementById("calInput").value = "";
  save();
  render();
}

function removeEntry(date) {
  state.log = state.log.filter(function(e) { return e.date !== date; });
  save();
  render();
}

function addWeighIn() {
  var dateVal = dateToStr(wiDate);
  var weightVal = document.getElementById("wi_weightInput").value;
  var weight = parseFloat(weightVal);
  if (!dateVal || !weightVal || isNaN(weight) || weight <= 0) return;
  var existing = -1;
  for (var i = 0; i < state.weighIns.length; i++) {
    if (state.weighIns[i].date === dateVal) { existing = i; break; }
  }
  if (existing >= 0) {
    state.weighIns[existing] = { date: dateVal, weight: weight };
  } else {
    state.weighIns.push({ date: dateVal, weight: weight });
    state.weighIns.sort(function(a,b) { return a.date.localeCompare(b.date); });
  }
  document.getElementById("wi_weightInput").value = "";
  save();
  render();
}

function updateSettingsPreview() {
  var sw = parseFloat(document.getElementById("s_startWeight").value) || state.settings.startWeight;
  var goal = parseFloat(document.getElementById("s_goalWeight").value) || state.settings.goalWeight;
  var tdee = parseInt(document.getElementById("s_tdee").value) || state.settings.tdee;
  var targetDate = document.getElementById("s_targetDate_hidden").value || state.settings.targetDate;

  // Use latest weigh-in weight if available
  var currentW = sw;
  if (state.weighIns.length > 0) currentW = state.weighIns[state.weighIns.length - 1].weight;

  var tc = calcTarget(currentW, goal, calcTDEE(currentW), targetDate);
  if (tc) {
    document.getElementById("ctp_lose").textContent = tc.toLose.toFixed(1) + " lbs";
    document.getElementById("ctp_days").textContent = tc.days;
    document.getElementById("ctp_deficit").textContent = tc.deficitNeeded.toLocaleString() + " cal/day";
    document.getElementById("ctp_target").textContent = tc.calTarget.toLocaleString() + " cal/day";
  }
}

function exportData() {
  var lines = state.log.map(function(e) { return e.date + "," + e.calories; });
  document.getElementById("importExportBox").value = lines.join("\n");
}

function importData() {
  var raw = document.getElementById("importExportBox").value.trim();
  if (!raw) return;
  var lines = raw.split("\n");
  var imported = [];
  var errors = 0;
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;
    var parts = line.split(",");
    if (parts.length !== 2) { errors++; continue; }
    var date = parts[0].trim();
    var cals = parseInt(parts[1].trim());
    if (!date.match(/^\d{4}-\d{2}-\d{2}$/) || isNaN(cals) || cals < 0) { errors++; continue; }
    imported.push({ date: date, calories: cals });
  }
  if (imported.length === 0) { alert("No valid entries found. Make sure you're pasting exported data."); return; }
  // Merge with existing, imported wins on conflict
  var merged = state.log.slice();
  for (var j = 0; j < imported.length; j++) {
    var found = false;
    for (var k = 0; k < merged.length; k++) {
      if (merged[k].date === imported[j].date) { merged[k] = imported[j]; found = true; break; }
    }
    if (!found) merged.push(imported[j]);
  }
  merged.sort(function(a,b) { return a.date.localeCompare(b.date); });
  state.log = merged;
  save();
  render();
  document.getElementById("importExportBox").value = "";
  var msg = "Imported " + imported.length + " entries.";
  if (errors > 0) msg += " " + errors + " lines skipped.";
  alert(msg);
}

function setActivity(level) {
  state.settings.activityLevel = level;
  document.getElementById("btn_sedentary").className = "toggle-btn" + (level === "sedentary" ? " toggle-btn-active" : "");
  document.getElementById("btn_lightly_active").className = "toggle-btn" + (level === "lightly_active" ? " toggle-btn-active" : "");
  updateSettingsPreview();
}

function openSettings() {
  setActivity(state.settings.activityLevel || "sedentary");
  settingsStartDate = state.settings.startDate;
  settingsTargetDate = state.settings.targetDate;
  document.getElementById("s_startDate_display").textContent = strToDate(state.settings.startDate).toLocaleDateString("en-US", {month:"short", day:"numeric", year:"numeric"});
  document.getElementById("s_targetDate_display").textContent = strToDate(state.settings.targetDate).toLocaleDateString("en-US", {month:"short", day:"numeric", year:"numeric"});
  document.getElementById("s_startDate_hidden").value = state.settings.startDate;
  document.getElementById("s_targetDate_hidden").value = state.settings.targetDate;
  document.getElementById("s_startWeight").value = state.settings.startWeight;

  document.getElementById("s_tdee").value = state.settings.tdee;
  document.getElementById("s_goalWeight").value = state.settings.goalWeight;

  updateSettingsPreview();
  document.getElementById("overlay").classList.add("open");
}

function closeSettings() {
  document.getElementById("overlay").classList.remove("open");
}

function overlayClick(e) {
  if (e.target === document.getElementById("overlay")) closeSettings();
}

function saveSettings() {
  var sw = parseFloat(document.getElementById("s_startWeight").value);
  var sd = document.getElementById("s_startDate_hidden").value;
  var tdee = parseInt(document.getElementById("s_tdee").value);
  var gw = parseFloat(document.getElementById("s_goalWeight").value);
  var td = document.getElementById("s_targetDate_hidden").value;
  // activityLevel saved live via setActivity(), no extra step needed
  if (!isNaN(sw)) state.settings.startWeight = sw;
  if (sd) state.settings.startDate = sd;
  if (!isNaN(tdee)) state.settings.tdee = tdee;
  if (!isNaN(gw)) state.settings.goalWeight = gw;
  if (td) state.settings.targetDate = td;
  save();
  closeSettings();
  render();
}

// Live preview in settings (only inputs, not date-nav components)
["s_startWeight","s_goalWeight","s_tdee"].forEach(function(id) {
  var el = document.getElementById(id);
  if (el) el.addEventListener("input", updateSettingsPreview);
});

document.getElementById("calInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") addEntry();
});
document.getElementById("wi_weightInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") addWeighIn();
});

if (!testStorage()) showStorageWarning();
load();
calDate = new Date(); calDate.setHours(0,0,0,0);
wiDate = new Date(); wiDate.setHours(0,0,0,0);
document.getElementById("calDateLabel").textContent = "Today";
document.getElementById("wiDateLabel").textContent = "Today";
render();
</script>
</body>
</html>
